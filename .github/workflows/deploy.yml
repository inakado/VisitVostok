name: Deploy to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Run type check
      run: npm run build
    
    - name: Run tests (if any)
      run: npm test --if-present

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /var/www/visitvostok
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–π –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏
          PACKAGE_CHANGED=$(git diff HEAD~1 HEAD --name-only | grep -E "(package\.json|package-lock\.json)" || echo "")
          
          if [ ! -z "$PACKAGE_CHANGED" ] || [ ! -d "node_modules" ]; then
            echo "üîÑ Package dependencies changed or node_modules missing - reinstalling..."
            rm -rf node_modules
            npm install
          else
            echo "üì¶ Dependencies unchanged - skipping reinstall"
          fi
          
          # Prisma –æ–ø–µ—Ä–∞—Ü–∏–∏
          npx prisma generate
          npx prisma migrate deploy
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–µ–Ω –ª–∏ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞)
          UNIQUE_PLACES=$(npx prisma db execute --url "$DATABASE_URL" --stdin <<< "SELECT COUNT(DISTINCT lat || ',' || lng) FROM \"Place\";" 2>/dev/null | grep -E "^\s*[0-9]+\s*$" | head -1 | tr -d ' ' || echo "0")
          echo "üìä –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç –≤ –±–∞–∑–µ: $UNIQUE_PLACES"
          
          if [ -z "$UNIQUE_PLACES" ] || [ "$UNIQUE_PLACES" -eq "0" ] || [ "$UNIQUE_PLACES" -lt "350" ]; then
            echo "üì• Importing places data..."
            npm run import-places || echo "Import failed, continuing..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –æ—á–∏—â–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            echo "üßπ Checking for duplicates..."
            npm run check-duplicates
            
            TOTAL_PLACES=$(npx prisma db execute --url "$DATABASE_URL" --stdin <<< "SELECT COUNT(*) FROM \"Place\";" 2>/dev/null | grep -E "^\s*[0-9]+\s*$" | head -1 | tr -d ' ' || echo "0")
            UNIQUE_AFTER=$(npx prisma db execute --url "$DATABASE_URL" --stdin <<< "SELECT COUNT(DISTINCT lat || ',' || lng) FROM \"Place\";" 2>/dev/null | grep -E "^\s*[0-9]+\s*$" | head -1 | tr -d ' ' || echo "0")
            
            if [ "$TOTAL_PLACES" -gt "$UNIQUE_AFTER" ]; then
              echo "üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã ($TOTAL_PLACES –∑–∞–ø–∏—Å–µ–π vs $UNIQUE_AFTER —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö). –û—á–∏—â–∞—é..."
              npm run clean-duplicates
            fi
          else
            echo "‚úÖ Database already populated ($UNIQUE_PLACES unique places)"
          fi
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          echo "üî® Building application (forced rebuild)..."
          rm -rf .next
          npm run build
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          pm2 restart visitvostok || pm2 start npm --name "visitvostok" -- start
          pm2 save
        command_timeout: 15m 